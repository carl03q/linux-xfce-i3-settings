function TB(){this._init("#tab-bundler-container",".tb-page","#tab-bundler-container","tb-page-toggler","tb-page-event");this.possibleKeys=["a","s","d","f","g","h","j","k","q","w","r","m","c","x"];this.archivedBundles=new ArchivedContainer("#archived-bundles","#archived-bundles-divider","shift+a").start();this.sharedBundles=new SharedContainer("#shared-bundles","#shared-bundles-divider","shift+s").start();this.ownBundles=new OwnContainer("#own-bundles","#bundles-divider","shift+b").start();this.responseRequired=[];this.synced=false;this.wheel=new Wheel("#pull-wheel")}TB.inherits(Page);TB.method("toggle",function(){this._toggle()});TB.method("insert",function(b,a){if(a.isSynced()){if(Account.loggedIn()){b.prepend(a)}}else{b.append(a)}});TB.method("getContainer",function(a){switch(true){case a.isHidden():return this.archivedBundles;case a.isShared():return this.sharedBundles;default:return this.ownBundles}});TB.method("addBundle",function(c,a){var b=new Bundle(c,a);this.insert(this.getContainer(b),b)});TB.method("fillBundles",function(){var d=this;var c=Object.keys(TBAccessor.getBundleJSON());var a=this._getHotkeys(c.length,this.possibleKeys.slice()).reverse();[d.archivedBundles,d.sharedBundles,d.ownBundles].map(function(e){e.clear()});c.map(function(e){d.addBundle(e,a.pop())});for(var b=0;b<d.responseRequired.length;b++){d.sharedBundles.prepend(d.responseRequired[b])}});TB.method("saveBundle",function(b,c,a){var d=this;this._makeBundle(b,c,function(e,f){if(TBAccessor.bundleExists(b)){if(e.hasChanged()){if(e.isSynced()||e.isShared()){e.updateLinks()}(new Bundle(b)).remove(true,true);e.update()}}else{e.save();if(Options.isset(Options.AutomaticallyAutosaveNewBundles)){Autosave.addTarget(e.bundleName)}}d.addBundle(e.bundleName);Autosave.addBundle(f,e.bundleName);a?a(e,f):false})});TB.method("updateBundleFromWindow",function(c,b,a){Browser.getTabList(b,{},function(d){var e=new Bundle(c);e.addTabs(d.map(function(f){var g=f.title?f.title:getHostname(f.url);return new Tab(g,f.url,e,f.pinned)}));e.update();if(e.isSynced()||e.isShared()){e.updateLinks()}a?a(e):false})});TB.method("pull",function(){if(Account.loggedIn()){this.wheel.start();this._pullOwn(this);this._pullShared(this)}});TB.method("start",function(){var a=this;Mousetrap.bindGlobal(["* m u s i c"],function(){Browser.getCurrentTabList(function(c,b){var d=[];c.map(function(e){if(e.url.toLowerCase().indexOf("youtube.com")!==-1){d.push("{0},{1}".format(e.title,e.url))}});downloadDataURI($,{filename:"music.tbm",data:"data:application/csv;charset=utf-8,{0}".format(encodeURIComponent(d.join("\n")))})})});$(document).on("tb-refresh",function(c,b){a.saveBundle(b,false,function(d){})});$(document).on("tb-unhide",function(c,b){a.ownBundles.append(new Bundle(b))});$(document).on("tb-hide",function(c,b){a.archivedBundles.append(new Bundle(b))});Mousetrap.bindGlobal("alt",function(){a.archivedBundles.highlightHotkeys();a.ownBundles.highlightHotkeys();a.archivedBundles.highlightHotkeys()});Mousetrap.bindGlobal("shift+l",function(){Popup.show(Messages.LatestOpenedBundleTitle,Messages.LatestOpenedBundle.format(TBAccessor.getLastOpen()))});this.bind("login",function(){a.pull()});this.bind("logout",function(){var c=SubscriptionHandler.getBundleList();for(subscription in c){new Bundle(subscription).remove(true)}SubscriptionHandler.resetBundleList();var b=TBSynchronizer.getBundleList();for(syncedBundle in b){new Bundle(syncedBundle).remove(true)}TBSynchronizer.resetBundleList();a.fillBundles();[a.archivedBundles,a.ownBundles].map(function(d){d._hideSpacer()})});$("#add_bundle_input").setDefault();$("#add_bundle_input").onEnter(function(b){$("#add_bundle").trigger("click")});$("#add_bundle").click(function(){var b=$("#add_bundle_input").val();if(a._validName(b)){a.saveBundle(b,false,function(c,d){Badge.setWindowBadge(d)})}});$("#add_bundle").rightClick(function(){var c=$("#add_bundle_input").val();var b={};b[ContextMenu.MakeEmptyBundle]=function(){if(a._validName(c)){a.saveBundle(c,true)}};ContextMenu.addMenuItems(b)})});TB.method("_getHotkeys",function(c,b){var a="";if(b.length>=c){return b}else{a=b.slice(b.length-1)}b=b.map(function(d){return a+d}).concat(b);b.pop();return this._getHotkeys(c,b)});TB.method("_makeBundle",function(b,c,a){Browser.getCurrentTabList(function(d,f){var e=new Bundle(b);if(!c){for(var g=0;g<d.length;g++){var h=d[g].title?d[g].title:getHostname(d[g].url);e.addTabs(new Tab(h,d[g].url,e,d[g].pinned))}}a(e,f)})});TB.method("_validName",function(b){var a=0;if(!b||b==$("#bundle_name").attr("default")){a=Messages.InvalidBundleName}else{if(TBAccessor.bundleExists(b)){a=Messages.BundleNameExists}}a?Popup.show(Messages.GeneralErrorTitle,a):false;return a?false:true});TB.method("_handlePull",function(){if(this.synced){this.synced=false;!this.changed||this.fillBundles();this.wheel.stop()}this.synced=true});TB.method("_pullOwn",function(a){TBSynchronizer.pull(Account.id(),Account.key(),function(b){TBAccessor.unhideSynced();TBAccessor.hide(JSON.parse(b.data["hidden-bundles"]),true)},function(b){a._errorCB(b,Messages.ErrorRetrievingBundles)},function(c,b,d){a.changed=a.changed||d;a._handlePull()})});TB.method("_pullShared",function(a){SubscriptionHandler.pull(Account.id(),Account.key(),function(c){var e=c["response-required"];for(var d=0;d<e.length;d++){var b=new SubscriptionInvite(e[d]);a.responseRequired.push(b)}},function(b){a._errorCB(b,Messages.ErrorRetrievingSharedBundles)},function(c,b,d){a.changed=a.changed||d;a._handlePull(d)})});TB.method("_errorCB",function(a,b){var c=this;if(Failure.UnmatchingIdAndKey.equals(a)||Failure.NotLoggedIn.equals(a)){c.trigger("startLogout")}else{Popup.show(Messages.GeneralErrorTitle,b)}});var Bundles=new TB();Bundles.start();