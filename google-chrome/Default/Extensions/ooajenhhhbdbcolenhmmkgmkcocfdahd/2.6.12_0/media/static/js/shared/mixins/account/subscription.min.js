function TBSubscription(){this._init("subscription","tb-subscribed");this.output=undefined;this.updatedBundles={}}TBSubscription.inherits(BundleAccessor);TBSubscription.method("remove",function(f,e,b,g,d,a){var c=this.getSubscription(b).name;this.uber("_remove",f,e,{subscriptionId:b},function(i,h){i.removeBundle(c);g?g(h):false},d,a)});TBSubscription.method("push",function(c,f,a,g,e,d,b){var i=this.getBundle(a);var h=i.bundleId;i.json=g;this.uber("_push",c,f,g,{bundleId:h},function(k,j){k.addBundle(a,i);e?e(j):false},d,b)});TBSubscription.method("pull",function(d,c,e,b,a){this.uber("_pull",d,c,function(l,h,k){var f=JSON.parse(h.data.subscriptions);var g={accepted:[],"response-required":[]};var n=l.getBundleList();var m=Object.keys(n);for(var j=0;j<m.length;j++){TBAccessor.removeBundle(m[j])}l.resetBundleList();for(var j=0;j<f.length;j++){var o=l._makeValidName(f[j]);if(parseInt(o.subscriberAccepted)){if(k&&n[o.name]){if(JSON.stringify(n[o.name].json)!=JSON.stringify(o.json)){l.updatedBundles[o.name]=true}}TBAccessor.updateBundle(o.name,o.json);g.accepted.push(o)}else{g["response-required"].push(o)}l.addBundle(o.name,o)}e?e(g):false},b,function(h,f,g){a?a(h,f,g):false})});TBSubscription.method("accept",function(c,b,e,d,a){var f={subscriptionId:e.id};this._accessWebsite("accept",c,b,f,function(h,g){e=h._makeValidName(e);e.subscriberAccepted=1;TBAccessor.updateBundle(e.name,e.json);h.addBundle(e.name,e);d?d(g,e):false},a)});TBSubscription.method("collaborate",function(c,b,e,g,d,a){var f={link:e,emails:g.join(",")};this._accessWebsite("collaborate",c,b,f,function(i,h){Analytics.send(Analytics.ShareByEmail,"Collaborate",g.join(","));d?d():false},a)});TBSubscription.method("isShared",function(a){return this.uber("isSynced",a)&&!!parseInt(this.getBundle(a).subscriberAccepted)});TBSubscription.method("isNewlyUpdated",function(a){return this.updatedBundles[a]!==undefined});TBSubscription.method("getInvites",function(){var d=this.getBundleList();var c=Object.keys(d);var b=[];for(var a=0;a<c.length;a++){if(d[c[a]].subscriberAccepted==0){b.push(d[c[a]])}}return b});TBSubscription.method("getSubscription",function(a){var d=this.getBundleList();var c=Object.keys(d);for(var b=0;b<c.length;b++){if(d[c[b]].id==a){return d[c[b]]}}});TBSubscription.method("_makeValidName",function(c){if(TBAccessor.bundleExists(c.name)){var b=1;var a=c.name;while(TBAccessor.bundleExists(c.name)){c.name="{0} ({1})".format(a,(++b).toString())}}return c});var SubscriptionHandler=new TBSubscription();